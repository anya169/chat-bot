{% load static %} 

<!DOCTYPE html>
<html>
<head>
   <title>Статистика</title>
   <link rel="stylesheet" href="{% static '/css/common.css' %}">
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class='layout'>
   {% block sidebar %}
      {% include 'includes/sidebar.html' %}
   {% endblock %}
   <main class="content">
      <h3>Статистика</h3>
      <div class="employees-panel">
         <h4>Пользователи, зарегистрировавшиеся в боте</h4>
         <div class="chart-container" style="height: 300px; width: 550px;">
            <canvas id="botUsageChart"></canvas>
         </div>
         <div class="chart-container" style="height: 300px; width: 550px;">
            <canvas id="botUsageFilialChart"></canvas>
         </div>
      </div>   
   </main>
</body>
</html> 
<script>
document.addEventListener('DOMContentLoaded', function() {
   const ctx = document.getElementById('botUsageChart').getContext('2d');
   
   const chartData = {
      labels: {{ bot_chart_data.labels|default:"[]"|safe }},
      datasets: [{
         data: {{ bot_chart_data.data|default:"[]" }},
         backgroundColor: {{ bot_chart_data.colors|default:"['#36a2eb','#ff6384']"|safe }},
         borderWidth: 1
      }]
   };

   if (chartData.labels.length === 0 || chartData.datasets[0].data.length === 0) {
      console.error("No chart data available");
      return;
   }

   new Chart(ctx, {
      type: 'pie',
      data: chartData,
      options: {
         responsive: true,
         maintainAspectRatio: false,
         plugins: {
               legend: {
                  position: 'right',
                  labels: {
                     generateLabels: function(chart) {
                           const data = chart.data;
                           // Добавляем проверки на существование данных
                           if (!data.labels || !data.datasets || data.datasets.length === 0) {
                              return [];
                           }
                           
                           const dataset = data.datasets[0];
                           const total = dataset.data.reduce((a, b) => a + b, 0);
                           
                           return data.labels.map(function(label, i) {
                              // Проверяем, существует ли элемент с индексом i
                              const value = dataset.data[i] || 0;
                              const bgColor = dataset.backgroundColor[i] || '#cccccc';
                              const borderColor = dataset.borderColor ? dataset.borderColor[i] || bgColor : bgColor;
                              const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                              
                              return {
                                 text: `${label}: ${value} (${percentage}%)`,
                                 fillStyle: bgColor,
                                 strokeStyle: borderColor,
                                 lineWidth: 1,
                                 hidden: false
                              };
                           });
                     }
                  }
               },
               tooltip: {
                  callbacks: {
                     label: function(context) {
                           const label = context.label || '';
                           const value = context.raw || 0;
                           const total = context.dataset.data.reduce((a, b) => a + b, 0);
                           const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                           return `${label}: ${value} (${percentage}%)`;
                     }
                  }
               }
         }
      }
   });
   const ctx1 = document.getElementById('botUsageFilialChart').getContext('2d');
   
   new Chart(ctx1, {
      type: 'bar',
      data: {
         labels: {{ bot_chart_filial_data.labels|safe }},
         datasets: [
               {
                  label: 'Используют бота',
                  data: {{ bot_chart_filial_data.bot_users|safe }},
                  backgroundColor: 'rgba(54, 162, 235, 0.7)',
                  borderColor: 'rgba(54, 162, 235, 1)',
                  borderWidth: 1
               },
               {
                  label: 'Всего сотрудников',
                  data: {{ bot_chart_filial_data.total_users|safe }},
                  backgroundColor: 'rgba(255, 99, 132, 0.7)',
                  borderColor: 'rgba(255, 99, 132, 1)',
                  borderWidth: 1
               }
         ]
      },
      options: {
         responsive: true,
         scales: {
               y: {
                  beginAtZero: true,
                  title: {
                     display: true,
                     text: 'Количество сотрудников'
                  },
                  ticks: {
                     stepSize: 1,
                     precision: 0
                  }
               },
               x: {
                  title: {
                     display: true,
                     text: 'Филиалы'
                  }
               }
         },
         plugins: {
               tooltip: {
                  callbacks: {
                     afterBody: function(context) {
                           const dataIndex = context[0].dataIndex;
                           return `Процент использования: ${ {{ bot_chart_filial_data.percentages|safe }}[dataIndex] }%`;
                     }
                  }
               },
         }
      }
   });
});
</script>